#!/usr/bin/env bash

set -e
[ -n "$PYENV_DEBUG" ] && set -x

if [ -z "$PYENV_ROOT" ]; then
  PYENV_ROOT="${HOME}/.pyenv"
fi

colorize() {
  if [ -t 1 ]; then printf "\e[%sm%s\e[m" "$1" "$2"
  else echo -n "$2"
  fi
}

# Checks for `.pyenv` file, and suggests to remove it for installing
if [ -d "${PYENV_ROOT}" ]; then
  { echo
    colorize 1 "WARNING"
    echo ": Can not proceed with installation. Kindly remove the '${PYENV_ROOT}' directory first."
    echo
  } >&2
    exit 1
fi

shell="$1"
if [ -z "$shell" ]; then
  shell="$(ps c -p "$PPID" -o 'ucomm=' 2>/dev/null || true)"
  shell="${shell##-}"
  shell="${shell%% *}"
  shell="$(basename "${shell:-$SHELL}")"
fi

failed_checkout() {
  echo "Failed to git clone $1"
  exit -1
}

checkout() {
  [ -d "$2" ] || git clone --depth 1 "$1" "$2" || failed_checkout "$1"
}

extract() {
  TEMP_DIR=$(mktemp -d pyenv-installer-XXXXXXXX)
  unzip $1 -d $TEMP_DIR >/dev/null
  ITEM_COUNT=$(ls -1 $TEMP_DIR | grep -c .)
  if [ $ITEM_COUNT -ne 1 ]; then
    rm -rf $TEMP_DIR
    echo "pyenv-installer: Archive $1 contains bad number of first level items: $ITEM_COUNT." >&2
    exit -1
  fi
  SUBDIR=$(ls -1 $TEMP_DIR)
  if [ ! -d $TEMP_DIR/$SUBDIR ]; then
    rm -rf $TEMP_DIR
    echo "pyenv-installer: Archive $1 does not contain a subdir." >&2
    exit -1
  fi
  mkdir -p $2
  (shopt -s dotglob; mv -t $2 $TEMP_DIR/$SUBDIR/*)
  rm -rf $TEMP_DIR
}

if [ -n "$PYENV_FROM_ZIP" ]; then
  # the user has downloaded a snapshot in form of separate zip files for the install
  REPO_PREFIX=./
  REPO_SUFFIX=-master.zip
  CHECKOUT=extract
else
  # the user wants to directly retrive the files from github using the git tool
  if ! command -v git 1>/dev/null 2>&1; then
    echo "pyenv: Git is not installed, can't continue." >&2
    exit 1
  fi

  if [ -n "${USE_GIT_URI}" ]; then
    GITHUB="git://github.com"
  else
    GITHUB="https://github.com"
  fi
  REPO_PREFIX=${GITHUB}/pyenv/
  REPO_SUFFIX=.git
  CHECKOUT=checkout
fi

${CHECKOUT} "${REPO_PREFIX}pyenv${REPO_SUFFIX}"            "${PYENV_ROOT}"
${CHECKOUT} "${REPO_PREFIX}pyenv-doctor${REPO_SUFFIX}"     "${PYENV_ROOT}/plugins/pyenv-doctor"
${CHECKOUT} "${REPO_PREFIX}pyenv-installer${REPO_SUFFIX}"  "${PYENV_ROOT}/plugins/pyenv-installer"
${CHECKOUT} "${REPO_PREFIX}pyenv-update${REPO_SUFFIX}"     "${PYENV_ROOT}/plugins/pyenv-update"
${CHECKOUT} "${REPO_PREFIX}pyenv-virtualenv${REPO_SUFFIX}" "${PYENV_ROOT}/plugins/pyenv-virtualenv"
${CHECKOUT} "${REPO_PREFIX}pyenv-which-ext${REPO_SUFFIX}"  "${PYENV_ROOT}/plugins/pyenv-which-ext"

if ! command -v pyenv 1>/dev/null; then
  { echo
    colorize 1 "WARNING"
    echo ": seems you still have not added 'pyenv' to the load path."
    echo
  } >&2

  case "$shell" in
  bash )
    profile="~/.bashrc"
    ;;
  zsh )
    profile="~/.zshrc"
    ;;
  ksh )
    profile="~/.profile"
    ;;
  fish )
    profile="~/.config/fish/config.fish"
    ;;
  * )
    profile="your profile"
    ;;
  esac

  { echo "# Load pyenv automatically by adding"
    echo "# the following to ${profile}:"
    echo
    case "$shell" in
    fish )
      echo "set -x PATH \"${PYENV_ROOT}/bin\" \$PATH"
      echo 'status --is-interactive; and . (pyenv init -|psub)'
      echo 'status --is-interactive; and . (pyenv virtualenv-init -|psub)'
      ;;
    * )
      echo "export PATH=\"${PYENV_ROOT}/bin:\$PATH\""
      echo "eval \"\$(pyenv init -)\""
      echo "eval \"\$(pyenv virtualenv-init -)\""
      ;;
    esac
  } >&2
fi
